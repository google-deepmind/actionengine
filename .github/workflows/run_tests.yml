name: Run tests

on:
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

concurrency:
  group: "cc-builds"
  cancel-in-progress: false

env:
  PATH: /usr/bin:/usr/local/bin:/opt/hostedtoolcache/pyenv/3.12.8/x64/bin:/opt/hostedtoolcache/pyenv/3.12.8/x64/shims

jobs:
  # Single deploy job since we're just deploying
  deploy:
    runs-on: ubuntu-latest
    steps:
    #    - name: Clear pyenv cache
    #      run: |
    #        sudo rm -rf /opt/hostedtoolcache/pyenv_root
    - name: setup pyenv
      uses: "gabrielfalcao/pyenv-action@v18"
      with:
        default: 3.12.8
        command: |
          pyenv global 3.12.8
    - name: Checkout
      uses: actions/checkout@v4
    - name: Update submodules
      run: git submodule sync --recursive
    - name: Download and build dependencies
      run: |
        export PATH="$(pyenv root)/shims:$PATH"
        sudo apt-get update
        sudo apt-get install -y cmake ninja-build
        cd third_party
        ./build_deps.sh
    - name: Configure and build
      run: |
        export PATH="$(pyenv root)/shims:$PATH"
        cmake -GNinja -S . -B build -DCMAKE_BUILD_TYPE=Release
        cmake --build build
    - name: Run tests
      run: |
        cd build
        ctest
